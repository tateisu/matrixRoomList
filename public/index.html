<html lang="ja">
<meta charset="UTF-8"/>

<script src="https://cdn.jsdelivr.net/npm/@riversun/sortable-table/lib/sortable-table.js"></script>
<script>

const escapeMap = {
  '&': '&amp;',
  "'": '&#x27;',
  '`': '&#x60;',
  '"': '&quot;',
  '<': '&lt;',
  '>': '&gt;',
};

function escapeEntities(src){
  if(typeof src !== 'string') return src;

  return src.replace( /[&'`"<>]/g, function(c) { return escapeMap[c] }); //'
}

function showTable(data){

	const sortableTable = new SortableTable();

	sortableTable.setTable(document.querySelector('#my-table1'));

	sortableTable.setCellRenderer((col, row) => {
	    const colValue = row[col.id];

		if (col.isHeader) {
			// cell-is-a-header
	    	if (typeof colValue === 'undefined') return '<th></th>'

			return `<th>${colValue}</th>`;
		}else{
			// cell-is-not-a-header
		    if (typeof colValue === 'undefined') return '<td></td>';

		    if (col.id === 'avatarUrlHttp') return `<td><img src="${colValue}" width="64 height="64"/></td>`;
		    if (col.id === 'canonical_alias') return `<td><a href="https://matrix.juggler.jp/#/room/${colValue}" target="_blank">${colValue}</a></td>`;

			return `<td>${colValue}</td>`;
		}
	});

	sortableTable.setData(data.rooms);

	let elem = document.querySelector('#updatedAt');
	if(elem) elem.innerHTML = escapeEntities(data.updatedAt);

	elem = document.querySelector('#servers');
	if(elem) elem.innerHTML = data.servers.map(function(v){ "<li>"+escapeEntities(v)+"/li"}).join("");

	elem = document.querySelector('#extraServers');
	if(elem) elem.innerHTML = data.extraServers.map(function(v){ "<li>"+escapeEntities(v)+"/li"}).join("");

}

window.onload = function() {
	let cacheBuster = Math.floor( (new Date().getTime()) / 3600000).toString();

	let dataUrl ="./data.json";
	if( window.location.href.toString().startsWith("file://") ){
		dataUrl = "https://matrix-room-list-jp.netlify.app/data.json";
	}

	fetch(`${dataUrl}?_=${cacheBuster}`)
	  .then(response => response.json())
	  .then(data => showTable(data));
};

</script>
<style>

*,*::before,*::after{box-sizing:border-box}body,h1,h2,h3,h4,p,figure,blockquote,dl,dd{margin:0}ul[role="list"],ol[role="list"]{list-style:none}html:focus-within{scroll-behavior:smooth}body{min-height:100vh;text-rendering:optimizeSpeed;line-height:1.5}a:not([class]){text-decoration-skip-ink:auto}img,picture{max-width:100%;display:block}input,button,textarea,select{font:inherit}@media(prefers-reduced-motion:reduce){html:focus-within{scroll-behavior:auto}*,*::before,*::after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important;scroll-behavior:auto !important}}

html{
	background-color: #fff;
	color:#000;
}

body{
	padding:12px;
}

table {
	margin-top:12px;
	border-collapse: collapse;
}

table th {
	padding: 3px;
	vertical-align: middle;
	border: solid 1px black;
	background-color: #eee;
}

table td{
	padding: 3px;
	vertical-align: middle;
	border: solid 1px black;
}

</style>

<h1>Matrix日本サーバ勢の公開部屋リスト</h1>

<p>更新頻度は適当です。要望などあれば <a href="https://mastodon.juggler.jp/@tateisu">@tateisu@mastodon.juggler.jp</a> へ投げてください。</p>

<h4>データ更新時刻</h4>
<ul id="updatedAt"/>

<h4>取得サーバ</h4>
<ul id="servers"/>

<h4>一部だけ取得しているサーバ</h4>
<ul id="extraServers"/>

<H4>部屋リスト</H4>
<noscript>JavaScriptを有効にしてください。</noscript>
<div class="sortable-table">
    <table id="my-table1">
        <thead>
        <tr>
            <th data-id="num_joined_members" sortable>人数</th>
            <th data-id="avatarUrlHttp" sortable>画像</th>
            <th data-id="name" sortable>名前</th>
            <th data-id="topic" sortable>トピック</th>
            <th data-id="canonical_alias" sortable>公開名</th>
            <th data-id="world_readable_int" sortable>外部<br/>閲覧<br/>可能</th>
            <th data-id="guest_can_join_int" sortable>ゲスト<br/>参加<br/>可能</th>
  <!--           <th data-id="room_id" sortable>部屋ID</th> -->
        </tr>
        </thead>
    </table>
</div>
</html>
